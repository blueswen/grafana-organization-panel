# Test info

- Name: Organization Panel - Select Mode >> should generate options for all organizations
- Location: /home/runner/work/grafana-organization-panel/grafana-organization-panel/tests/panel.spec.ts:92:7

# Error details

```
Error: Timed out 5000ms waiting for expect(locator).toHaveCount(expected)

Locator: locator('#--r1b---downshift-menu [role="option"] span')
Expected: 10
Received: 0
Call log:
  - expect.toHaveCount with timeout 5000ms
  - waiting for locator('#--r1b---downshift-menu [role="option"] span')
    9 Ã— locator resolved to 0 elements
      - unexpected value "0"

    at /home/runner/work/grafana-organization-panel/grafana-organization-panel/tests/panel.spec.ts:102:27
```

# Page snapshot

```yaml
- link "Skip to main content":
  - /url: "#pageContent"
- button "Close menu":
  - img "Grafana"
- log
- text: Main Org.
- combobox "Change organization"
- button "Undock menu"
- navigation:
  - list "Navigation":
    - listitem:
      - link "Home":
        - /url: /
    - listitem:
      - link "Bookmarks":
        - /url: /bookmarks
      - 'button "Expand section: Bookmarks"'
    - listitem:
      - link "Starred":
        - /url: /dashboards?starred
      - 'button "Expand section: Starred"'
    - listitem:
      - link "Dashboards":
        - /url: /dashboards
      - 'button "Expand section: Dashboards"'
    - listitem:
      - link "Explore":
        - /url: /explore
    - listitem:
      - link "Drilldown New!":
        - /url: /drilldown
      - 'button "Expand section: Drilldown"'
    - listitem:
      - link "Alerting":
        - /url: /alerting
      - 'button "Expand section: Alerting"'
    - listitem:
      - link "Connections":
        - /url: /connections
      - 'button "Expand section: Connections"'
    - listitem:
      - link "Administration":
        - /url: /admin
      - 'button "Expand section: Administration"'
- banner:
  - navigation "Breadcrumbs":
    - list:
      - listitem:
        - link "Home":
          - /url: /
      - listitem:
        - link "Dashboards":
          - /url: /dashboards
      - listitem:
        - link "Provisioned organization panel dashboard":
          - /url: /d/a538aeff-5a8a-42a5-901c-938d896fdd6f/provisioned-organization-panel-dashboard?orgId=1&from=now-6h&to=now&timezone=browser
      - listitem: Edit panel
  - button "Search..."
  - text: ctrl+k
  - button "New"
  - button "Help"
  - button "Profile":
    - img "User avatar"
  - button "Back to dashboard"
  - button "Discard panel changes" [disabled]
  - button "Save dashboard"
  - button "More save options"
- main:
  - text: Table view
  - switch "Toggle table view"
  - 'button "Time range selected: Last 6 hours"': Last 6 hours
  - button "Zoom out time range"
  - button "Refresh"
  - button "Auto refresh turned off. Choose refresh time interval"
  - region "Organization panel with select":
    - heading "Organization panel with select" [level=2]
    - button "Menu for panel Organization panel with select"
    - combobox "Main Org." [expanded]
  - separator "Pane resize widget"
  - tablist:
    - tab "Queries1" [selected]
    - tab "Transformations0"
  - text: Data source
  - img "-- Grafana -- logo"
  - textbox "Select a data source"
  - button "Open data source help"
  - button "Expand query row"
  - text: Query options MD = auto = 618 Interval = 30s
  - button "Query inspector button": Query inspector
  - button "Collapse query row" [expanded]
  - button "Query editor row title A": A
  - emphasis: (-- Grafana --)
  - button "Duplicate query"
  - button "Hide response"
  - button "Remove query"
  - button "Drag and drop to reorder":
    - img "Drag and drop to reorder"
  - text: Query type
  - log
  - text: Random Walk
  - combobox
  - button "Add query"
  - button "Expression"
  - separator "Pane resize widget"
  - text: Visualization
  - button "Change visualization": Organization Panel
  - button
  - heading "Panel options" [level=6]
  - button [expanded]
  - text: Title
  - textbox: Organization panel with select
  - text: Description
  - textbox
  - text: Transparent background
  - switch
  - heading "Panel links" [level=6]
  - button
  - heading "Repeat options" [level=6]
  - button
  - heading "Organization Panel" [level=6]
  - button [expanded]
  - text: Display mode
  - radiogroup:
    - radio "Select" [checked]
    - text: Select
    - radio "Button"
    - text: Button
    - radio "Collapsible Button"
    - text: Collapsible Button
- listbox:
  - option "Alpha Org."
  - option "Beta Org."
  - option "Delta Org."
  - option "Epsilon Org."
  - option "Eta Org."
  - option "Gamma Org."
  - option "Iota Org."
  - option "Main Org." [selected]
  - option "Theta Org."
  - option "Zeta Org."
```

# Test source

```ts
   2 | import { getGrafanaBootData, switchOrg, getOrgList, getPanelContentSelector } from './utils';
   3 |
   4 | test.describe('Organization Panel - Button Mode', () => {
   5 |   test.beforeEach(async ({ page, gotoPanelEditPage, readProvisionedDashboard }) => {
   6 |     // Switch to the Main Org.
   7 |     await switchOrg(page, 1);
   8 |
   9 |     const dashboard = await readProvisionedDashboard({ fileName: 'dashboard.json' });
   10 |     await gotoPanelEditPage({ dashboard, id: '2' });
   11 |
   12 |     // Wait for the organization panel to be visible
   13 |     await page.waitForSelector('div[data-testid="data-testid panel content"]');
   14 |   });
   15 |
   16 |   test.afterEach(async ({ page }) => {
   17 |     // Switch back to the Main Org.
   18 |     await switchOrg(page, 1);
   19 |   });
   20 |
   21 |   test('should generate buttons for all organizations', async ({ page }) => {
   22 |     // Get the list of organizations
   23 |     const orgList = await getOrgList(page);
   24 |
   25 |     // Check if the buttons are generated
   26 |     const buttons = await page.locator('button[data-testid^="org-"]');
   27 |     await expect(buttons).toHaveCount(orgList.length);
   28 |
   29 |     // Check if the buttons have the correct text and data-testid
   30 |     for (const org of orgList) {
   31 |       const button = page.locator(`button[data-testid="org-${org.id}"]`);
   32 |       await expect(button).toHaveText(org.name);
   33 |     }
   34 |   });
   35 |
   36 |   test('should highlight the current user organization', async ({ page }) => {
   37 |     // Get the current organization ID
   38 |     const grafanaBootData = await getGrafanaBootData(page);
   39 |     expect(grafanaBootData.user).toHaveProperty('orgId');
   40 |     const currentOrgId = grafanaBootData.user.orgId;
   41 |
   42 |     // Check if the button is active
   43 |     const button = page.locator(`button[data-testid="org-${currentOrgId}"]`);
   44 |     await expect(button).toHaveClass(/active/);
   45 |   });
   46 |
   47 |   test('should switch organization when clicking a button', async ({ page }) => {
   48 |     const grafanaBootData = await getGrafanaBootData(page);
   49 |     const currentOrgId = grafanaBootData.user.orgId;
   50 |
   51 |     // Switch to a different organization
   52 |     const orgButtons = await page.locator('button[data-testid^="org-"]').all();
   53 |     let newOrgId = '';
   54 |     for (const button of orgButtons) {
   55 |       const orgId = await button.getAttribute('data-testid');
   56 |       if (orgId != null && orgId !== `org-${currentOrgId}`) {
   57 |         newOrgId = orgId.replace('org-', '');
   58 |         console.log(`Redirect to org: ${newOrgId}`);
   59 |         await button.click();
   60 |         await page.waitForURL((url) => url.searchParams.get('orgId') === orgId.replace('org-', ''));
   61 |         break;
   62 |       }
   63 |     }
   64 |
   65 |     if (newOrgId === '') {
   66 |       throw new Error('Failed to find a different organization');
   67 |     }
   68 |
   69 |     // Check if the organization has been switched
   70 |     const newGrafanaBootData = await getGrafanaBootData(page);
   71 |     expect(newGrafanaBootData.user.orgId.toString()).toBe(newOrgId);
   72 |   });
   73 | });
   74 |
   75 | test.describe('Organization Panel - Select Mode', () => {
   76 |   test.beforeEach(async ({ page, gotoPanelEditPage, readProvisionedDashboard }) => {
   77 |     // Switch to the Main Org.
   78 |     await switchOrg(page, 1);
   79 |
   80 |     const dashboard = await readProvisionedDashboard({ fileName: 'dashboard.json' });
   81 |     await gotoPanelEditPage({ dashboard, id: '1' });
   82 |
   83 |     // Wait for the organization panel to be visible
   84 |     await page.waitForSelector('div[data-testid="data-testid panel content"]');
   85 |   });
   86 |
   87 |   test.afterEach(async ({ page }) => {
   88 |     // Switch back to the Main Org.
   89 |     await switchOrg(page, 1);
   90 |   });
   91 |
   92 |   test('should generate options for all organizations', async ({ page, selectors }) => {
   93 |     // Get the list of organizations
   94 |     const orgList = await getOrgList(page);
   95 |
   96 |     const { panel, input } = getPanelContentSelector(page);
   97 |     await expect(panel).toBeVisible();
   98 |     await input.click();
   99 |     
  100 |     const menuId = await input.getAttribute('aria-controls');
  101 |     const options = page.locator(`#${menuId} [role="option"] span`);
> 102 |     await expect(options).toHaveCount(orgList.length);
      |                           ^ Error: Timed out 5000ms waiting for expect(locator).toHaveCount(expected)
  103 |
  104 |     // Check if the options have the correct text
  105 |     for (let i = 0; i < orgList.length; i++) {
  106 |       const option = options.nth(i);
  107 |       const optionText = await option.textContent();
  108 |       expect(optionText).toBe(orgList[i].name);
  109 |     }
  110 |   });
  111 |
  112 |   test('should select the current user organization', async ({ page }) => {
  113 |     // Get the current organization ID
  114 |     const grafanaBootData = await getGrafanaBootData(page);
  115 |     expect(grafanaBootData.user).toHaveProperty('orgId');
  116 |     const currentOrgId = grafanaBootData.user.orgId;
  117 |     const currentOrgName = grafanaBootData.user.orgName;
  118 |
  119 |     const { panel, input } = getPanelContentSelector(page);
  120 |     await expect(panel).toBeVisible();
  121 |     const selectedValue = await input.getAttribute('value');
  122 |
  123 |     expect(selectedValue).toBe(currentOrgName);
  124 |   });
  125 |
  126 |   test('should switch organization when selecting an option', async ({ page, gotoPanelEditPage }) => {
  127 |     const grafanaBootData = await getGrafanaBootData(page);
  128 |     const currentOrgId = grafanaBootData.user.orgId;
  129 |
  130 |     // Get the list of organizations
  131 |     const orgList = await getOrgList(page);
  132 |
  133 |     const { panel, input } = getPanelContentSelector(page);
  134 |     await expect(panel).toBeVisible();
  135 |     await input.click();
  136 |     
  137 |     const menuId = await input.getAttribute('aria-controls');
  138 |     const options = page.locator(`#${menuId} [role="option"] span`);
  139 |
  140 |     await expect(options).toHaveCount(orgList.length);
  141 |
  142 |     // Switch to a different organization
  143 |     let newOrgId = '';
  144 |     let newOrgName = '';
  145 |     for (const org of orgList) {
  146 |       if (org.id !== Number(currentOrgId)) {
  147 |         newOrgId = org.id.toString();
  148 |         newOrgName = org.name;
  149 |         console.log(`Redirect to org: ${newOrgId}`);
  150 |         let option = null;
  151 |         option = options.filter({ hasText: org.name });
  152 |
  153 |         await expect(option).toBeVisible();
  154 |         await option.click();
  155 |         await page.waitForURL((url) => url.searchParams.get('orgId') === newOrgId);
  156 |         break;
  157 |       }
  158 |     }
  159 |
  160 |     if (newOrgId === '') {
  161 |       throw new Error('Failed to find a different organization');
  162 |     }
  163 |
  164 |     // Check if the organization has been switched
  165 |     const newGrafanaBootData = await getGrafanaBootData(page);
  166 |     expect(newGrafanaBootData.user.orgId.toString()).toBe(newOrgId);
  167 |   });
  168 | });
  169 |
```